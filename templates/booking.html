{% extends "base.html" %}
{% load static %}
{% block head %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Rental Booking</title>
    <link rel="stylesheet" href="{static 'booking.css'}">
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k79vwqGsfqMVcSurYfZu6J362uvF0owHoaVAUkE/DunR0lCjxZKDtdRn2U6U6JUkyD/rEaUB8JpB5wDtmSgA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{% endblock %}

{% block content %}
    <h1>Booking</h1>
    <div class="message">
        {% if message %}
            <p>{{ message }}</p>
        {% endif %}
    </div>
    <div class="content-container">
        {% if car %}
        <div class="car-container">
            <div class="car">
                <img src="{{ car.image.url }}" alt="Car Image">
                <div class="specifications">
                    <h3>Specifications</h3>
                    <ul>
                        <li>Company: {{ car.company }}</li>
                        <li>Model: {{ car.model }}</li>
                        <li>Mileage: {{ car.mileage }} kilometers per liter</li>
                        <li>Transmission: {{ car.transmission }}</li>
                        <li>Seats: {{ car.seats }}</li>
                        <li>Luggage: {{ car.luggage }}</li>
                        <li>Fuel: {{ car.fuel }}</li>
                        <li>Cost: {{ car.hourly_rate }} /hr</li> <!-- Cost added here -->
                    </ul>
                </div>
            </div>
        </div>
    {% endif %}

       
    <div class="vertical-container">
      <h3>Book a Car</h3>
    
      <form method="post" id="carForm">
        {% csrf_token %}
        <p class="input-label" hidden>Pick Up Location</p>
        <select name="{{ form.location.name }}" id="id_location" class="location-dropdown" hidden>
          <option value="Kathmandu">Kathmandu</option>
          <option value="Pokhara">Pokhara</option>
        </select>
        <p class="input-label">Pick Up Date</p>
        <input type="text" name="{{ form.pickup_datetime.name }}" required="" id="id_pickup_datetime" class="date-input flatpickr">
    
        <p class="input-label">Drop Off Date</p>
        <input type="text" name="{{ form.dropoff_datetime.name }}" required="" id="id_dropoff_datetime" class="date-input flatpickr">
    
        <p class="input-label" >Estimated Pricing : </p>
        <input type="text" readonly id="estimated_price">
        <script>
            flatpickr(".flatpickr", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
            });
        </script>
    
        <button type="submit">Rent a Car now</button>
      </form>

      <input type="hidden" id="hourly-rate" value="{{ car.hourly_rate }}">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      <script>
        window.onload = function() {
            var location = localStorage.getItem('location');
            var pickup_datetime = localStorage.getItem('pickup_datetime');
            var dropoff_datetime = localStorage.getItem('dropoff_datetime');
    
            if (location) {
                document.getElementById('id_location').value = location;
            }
            if (pickup_datetime) {
                document.getElementById('id_pickup_datetime').value = pickup_datetime;
            }
            if (dropoff_datetime) {
                document.getElementById('id_dropoff_datetime').value = dropoff_datetime;
            }
            var hourlyRate = parseFloat($("#hourly-rate").val());
        
            var calculateTotalCost = function() {
                var pickupTime = new Date($("#id_pickup_datetime").val().replace(" ", "T"));
                var dropoffTime = new Date($("#id_dropoff_datetime").val().replace(" ", "T"));
        
                if (pickupTime && dropoffTime) {
                    var diff = Math.abs(dropoffTime - pickupTime);  // difference in milliseconds
                    var hours = diff / 1000 / 60 / 60;  // convert to hours
        
                    var totalCost = hours * hourlyRate;
        
                    $("#estimated_price").val(totalCost.toFixed(2));
                }
            };
            
            calculateTotalCost();  // Invoke the function
        };
    </script>

    </div>

    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function(){
            var hourlyRate = parseFloat($("#hourly-rate").val());
        
            $("#id_pickup_datetime, #id_dropoff_datetime").change(function(){
                var pickupTime = new Date($("#id_pickup_datetime").val().replace(" ", "T"));
                var dropoffTime = new Date($("#id_dropoff_datetime").val().replace(" ", "T"));
        
                if (pickupTime && dropoffTime) {
                    var diff = Math.abs(dropoffTime - pickupTime);  // difference in milliseconds
                    var hours = diff / 1000 / 60 / 60;  // convert to hours
        
                    var totalCost = hours * hourlyRate;
        
                    $("#estimated_price").val(totalCost.toFixed(2));
                }
            });
        });
    </script>

{% endblock %}
